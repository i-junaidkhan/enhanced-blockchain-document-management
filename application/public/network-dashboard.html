<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Network Dashboard - Live Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* Network Flow Visualization */
        .flow-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .network-path { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        /* Peer Nodes */
        .peer-group { display: flex; justify-content: center; gap: 10px; padding: 15px; border-radius: 8px; position: relative; }
        .origin-group { background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
        .orderer-group { background: linear-gradient(135deg, #fff3e0, #ffe0b2); }
        .dest-group { background: linear-gradient(135deg, #e8f5e8, #c8e6c8); }
        
        .peer-node {
            background: #ffffff;
            padding: 12px;
            border-radius: 8px;
            border: 3px solid #ddd;
            position: relative;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
        }
        
        .peer-node.processing { 
            border-color: #ffc107; 
            background: #fff8e1; 
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
            animation: pulse 1s infinite;
        }
        
        .peer-node.success { 
            border-color: #28a745; 
            background: #d4edda; 
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }
        
        .peer-node.error { 
            border-color: #dc3545; 
            background: #f8d7da; 
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
        }
        
        /* Document Animation */
        .document-packet {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            opacity: 0;
            z-index: 100;
            transition: all 0.5s ease;
        }
        
        .document-packet.moving {
            opacity: 1;
            animation: moveDocument 0.8s ease-in-out;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes moveDocument {
            0% { transform: translateY(-20px) scale(0.8); opacity: 0; }
            50% { transform: translateY(-10px) scale(1.1); opacity: 1; }
            100% { transform: translateY(0px) scale(1); opacity: 1; }
        }
        
        /* Flow Arrows */
        .flow-arrow {
            font-size: 24px;
            color: #007bff;
            text-align: center;
            position: relative;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        /* Status Panel */
        .status-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-item { padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff; }
        .status-success { border-left-color: #28a745; background: #d4edda; }
        .status-processing { border-left-color: #ffc107; background: #fff3cd; }
        .status-error { border-left-color: #dc3545; background: #f8d7da; }
        
        /* Transaction Log */
        .transaction-log {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Live Blockchain Network Dashboard</h1>
            <p>Real-time Document Flow Visualization</p>
        </div>

        <div class="dashboard-grid">
            <!-- Network Flow Visualization -->
            <div class="flow-container">
                <h2>üöÄ Live Document Flow</h2>
                
                <div class="network-path">
                    <!-- Origin Peers -->
                    <div class="peer-group origin-group">
                        <h3>üì§ Origin Organization</h3>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <div class="peer-node" id="origin-station">
                                <div>üöâ</div>
                                <div>Station</div>
                                <div style="font-size: 10px;">:7051</div>
                            </div>
                            <div class="peer-node" id="origin-rail">
                                <div>üöÇ</div>
                                <div>Rail</div>
                                <div style="font-size: 10px;">:8051</div>
                            </div>
                            <div class="peer-node" id="origin-customs">
                                <div>üõÉ</div>
                                <div>Customs</div>
                                <div style="font-size: 10px;">:9051</div>
                            </div>
                            <div class="peer-node" id="origin-border">
                                <div>üõÇ</div>
                                <div>Border</div>
                                <div style="font-size: 10px;">:10051</div>
                            </div>
                        </div>
                    </div>

                    <div class="flow-arrow">‚¨áÔ∏è Endorsement ‚¨áÔ∏è</div>

                    <!-- Orderers -->
                    <div class="peer-group orderer-group">
                        <h3>üèõÔ∏è Consensus Layer</h3>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <div class="peer-node" id="orderer1">
                                <div>üèõÔ∏è</div>
                                <div>Orderer1</div>
                                <div style="font-size: 10px;">:7050</div>
                            </div>
                            <div class="peer-node" id="orderer2">
                                <div>üèõÔ∏è</div>
                                <div>Orderer2</div>
                                <div style="font-size: 10px;">:8050</div>
                            </div>
                            <div class="peer-node" id="orderer3">
                                <div>üèõÔ∏è</div>
                                <div>Orderer3</div>
                                <div style="font-size: 10px;">:9050</div>
                            </div>
                        </div>
                    </div>

                    <div class="flow-arrow">‚¨áÔ∏è Block Commit ‚¨áÔ∏è</div>

                    <!-- Destination Peers -->
                    <div class="peer-group dest-group">
                        <h3>üì• Destination Organization</h3>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <div class="peer-node" id="dest-station">
                                <div>üöâ</div>
                                <div>Station</div>
                                <div style="font-size: 10px;">:11051</div>
                            </div>
                            <div class="peer-node" id="dest-rail">
                                <div>üöÇ</div>
                                <div>Rail</div>
                                <div style="font-size: 10px;">:12051</div>
                            </div>
                            <div class="peer-node" id="dest-customs">
                                <div>üõÉ</div>
                                <div>Customs</div>
                                <div style="font-size: 10px;">:13051</div>
                            </div>
                            <div class="peer-node" id="dest-border">
                                <div>üõÇ</div>
                                <div>Border</div>
                                <div style="font-size: 10px;">:14051</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Packet (animated) -->
                <div class="document-packet" id="documentPacket">üìÑ</div>
                
                <!-- Submit Form -->
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>üì§ Submit New Document</h3>
                    <form id="submitForm">
                        <input type="file" id="fileInput" required style="margin: 5px 0; padding: 8px; width: 100%;">
                        <input type="text" id="submitter" placeholder="Submitter name" required style="margin: 5px 0; padding: 8px; width: 100%;">
                        <button type="submit" style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 4px; width: 100%;">
                            üöÄ Submit & Watch Flow
                        </button>
                    </form>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="status-panel">
                <h2>üìä Live Status</h2>
                
                <div id="networkStatus">
                    <div class="status-item">Loading network status...</div>
                </div>

                <h3>üìã Transaction Log</h3>
                <div class="transaction-log" id="transactionLog">
                    Ready for document submission...
                </div>

                <h3>üìà Statistics</h3>
                <div id="stats">
                    <div>Documents Processed: <strong id="docCount">0</strong></div>
                    <div>Success Rate: <strong id="successRate">100%</strong></div>
                    <div>Avg Processing Time: <strong id="avgTime">0s</strong></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8081';
        let transactionCount = 0;
        let successCount = 0;

        // Peer flow sequence
        const flowSequence = [
            'origin-station', 'origin-rail', 'origin-customs', 'origin-border',
            'orderer1', 'orderer2', 'orderer3',
            'dest-station', 'dest-rail', 'dest-customs', 'dest-border'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateNetworkStatus();
            setupEventListeners();
            setInterval(updateNetworkStatus, 30000);
        });

        function setupEventListeners() {
            document.getElementById('submitForm').addEventListener('submit', submitDocumentWithAnimation);
        }

        function addLog(message) {
            const log = document.getElementById('transactionLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML = `[${timestamp}] ${message}\n` + log.innerHTML;
        }

        async function submitDocumentWithAnimation(e) {
            e.preventDefault();
            
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            addLog('üöÄ Document submission started...');
            
            // Start animation sequence
            await animateDocumentFlow(file);
        }

        async function animateDocumentFlow(file) {
            const startTime = Date.now();
            transactionCount++;

            try {
                // Phase 1: Origin Peers Processing
                addLog('üì§ Processing at Origin Organization...');
                await animatePeers(['origin-station', 'origin-rail', 'origin-customs', 'origin-border'], 'processing');
                await sleep(1000);
                await animatePeers(['origin-station', 'origin-rail', 'origin-customs', 'origin-border'], 'success');
                addLog('‚úÖ Origin peers endorsed transaction');

                // Phase 2: Orderer Consensus
                addLog('üèõÔ∏è Orderer consensus in progress...');
                await animatePeers(['orderer1', 'orderer2', 'orderer3'], 'processing');
                await sleep(1500);
                await animatePeers(['orderer1', 'orderer2', 'orderer3'], 'success');
                addLog('‚úÖ Consensus achieved - Block created');

                // Phase 3: Submit to blockchain
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_URL}/documents`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (response.ok) {
                    // Phase 4: Destination Peers Update
                    addLog('üì• Broadcasting to Destination Organization...');
                    await animatePeers(['dest-station', 'dest-rail', 'dest-customs', 'dest-border'], 'processing');
                    await sleep(1000);
                    await animatePeers(['dest-station', 'dest-rail', 'dest-customs', 'dest-border'], 'success');
                    
                    successCount++;
                    const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
                    
                    addLog(`üéâ Document ${result.docID.substring(0, 8)} successfully processed!`);
                    addLog(`üìä Processing time: ${processingTime}s`);
                    
                    // Reset form
                    document.getElementById('submitForm').reset();
                    
                    // Update stats
                    updateStats();
                    
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`);
                await animateAllPeers('error');
                await sleep(2000);
            }

            // Reset all peers
            await sleep(3000);
            await resetAllPeers();
        }

        async function animatePeers(peerIds, status) {
            for (const peerId of peerIds) {
                const peer = document.getElementById(peerId);
                if (peer) {
                    peer.className = `peer-node ${status}`;
                }
            }
            await sleep(300);
        }

        async function animateAllPeers(status) {
            for (const peerId of flowSequence) {
                const peer = document.getElementById(peerId);
                if (peer) {
                    peer.className = `peer-node ${status}`;
                }
            }
        }

        async function resetAllPeers() {
            for (const peerId of flowSequence) {
                const peer = document.getElementById(peerId);
                if (peer) {
                    peer.className = 'peer-node';
                }
            }
        }

        function updateStats() {
            document.getElementById('docCount').textContent = transactionCount;
            document.getElementById('successRate').textContent = transactionCount > 0 ? 
                Math.round((successCount / transactionCount) * 100) + '%' : '100%';
        }

        async function updateNetworkStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('networkStatus');
                
                if (data.status === 'OK') {
                    statusDiv.innerHTML = `
                        <div class="status-item status-success">
                            ‚úÖ Network: HEALTHY<br>
                            Channel: ${data.channel || 'logistics-channel'}<br>
                            Chaincode: ${data.chaincode || 'document_cc'}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status-item status-error">
                            ‚ùå Network: ERROR<br>
                            ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('networkStatus').innerHTML = `
                    <div class="status-item status-error">
                        ‚ùå API: DISCONNECTED<br>
                        Cannot connect to blockchain
                    </div>
                `;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
